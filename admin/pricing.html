<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Giá bán - MoonCake Delight</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="../assets/css/admin_style.css" />
    <style>
      .profit-input { width: 80px; padding: 6px; text-align: center; border-radius: 6px; border: 1px solid #ccc; margin: auto; display: block;}
    </style>
  </head>
  <body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo-wrap">
                <div class="logo-img">
                    <i class="fas fa-moon" style="font-size: 2rem; color: var(--brand-crimson);"></i>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-start">
                    <div style="font-weight:800;color:#fff;font-size:1rem">MORICO</div>
                    <div style="font-size:0.75rem;color:rgba(255,255,255,0.92)">Bánh Trung Thu</div>
                </div>
            </div>
        </div>
        <nav class="nav-menu">
            <div class="nav-section">
                <div class="nav-title">Bảng điều khiển</div>
                <a href="dashboard.html"><i class="fas fa-home"></i><span>Trang chủ</span></a>
            </div>
            <div class="nav-section">
                <div class="nav-title">Quản lý</div>
                <a href="users.html"><i class="fas fa-users"></i><span>Người dùng</span></a>
                <a href="categories.html"><i class="fas fa-tags"></i><span>Loại sản phẩm</span></a>
                <a href="products.html"><i class="fas fa-box"></i><span>Sản phẩm</span></a>
                <a href="purchase-orders.html"><i class="fas fa-truck-loading"></i><span>Nhập hàng</span></a>
                <a href="pricing.html" class="active"><i class="fas fa-dollar-sign"></i><span>Quản lý giá</span></a>
                <a href="orders.html"><i class="fas fa-shopping-cart"></i><span>Đơn hàng</span></a>
                <a href="inventory.html"><i class="fas fa-warehouse"></i><span>Tồn kho</span></a>
                
            </div>
        </nav>
    </aside>

    <main class="main-content">
      <div class="main-header">
            <h1><i class="fas fa-dollar-sign"></i> Quản lý Giá bán</h1>
            <div class="header-actions">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Tìm kiếm...">
                </div>
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user" style="font-size: 1.2rem; color: var(--brand-crimson);"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="header-username">Người dùng</div>
                        <div class="user-role" id="header-role">Quản lý</div>
                    </div>
                    <button class="logout-btn" id="logout-btn">Đăng xuất</button>
                </div>
            </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-calculator"></i> Tra cứu và Tinh chỉnh Giá bán</h2>
          </div>
          <div style="padding: 1.5rem;">
            <div style="overflow-x: auto;">
              <table>
                <thead>
                  <tr style="background: rgba(230,190,138,0.15);">
                    <th>Tên sản phẩm</th>
                    <th>Loại SP</th>
                    <th style="text-align:right;">Giá vốn</th>
                    <th style="text-align:center;">% Lợi nhuận</th>
                    <th style="text-align:right;">Giá bán</th>
                    <th style="text-align:center;">Hành động</th>
                  </tr>
                </thead>
                <tbody id="pricing-table-body">
                  <tr>
                    <td>Bánh nướng thập cẩm <span style="font-size: 0.85rem; color: #9E9E9E;">(BNTC001)</span></td>
                    <td>Bánh nướng</td>
                    <td style="text-align:right; color: #D32F2F;">45,000đ</td>
                    <td style="text-align:center;">
                      <input type="number" class="profit-input" value="44.4" min="0" max="200" step="0.5">
                    </td>
                    <td style="text-align:right;"><span style="font-weight: bold;">65,000đ</span></td>
                    <td class="action-group" style="justify-content:center;">
                      <button class="btn-show btn-action-small" onclick="savePrice(this)"><i class="fas fa-save"></i> Lưu</button>
                      <button class="btn-secondary btn-action-small" onclick="resetPrice(this)"><i class="fas fa-undo"></i> Reset</button>
                    </td>
                  </tr>
                  <tr>
                    <td>Bánh nướng đậu xanh <span style="font-size: 0.85rem; color: #9E9E9E;">(BNDX001)</span></td>
                    <td>Bánh nướng</td>
                    <td style="text-align:right; color: #D32F2F;">40,000đ</td>
                    <td style="text-align:center;">
                      <input type="number" class="profit-input" value="37.5" min="0" max="200" step="0.5">
                    </td>
                    <td style="text-align:right;"><span style="font-weight: bold;">55,000đ</span></td>
                    <td class="action-group" style="justify-content:center;">
                      <button class="btn-show btn-action-small" onclick="savePrice(this)"><i class="fas fa-save"></i> Lưu</button>
                      <button class="btn-secondary btn-action-small" onclick="resetPrice(this)"><i class="fas fa-undo"></i> Reset</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="footer">
            <p>© 2023 Hệ thống Quản lý Bánh Trung Thu MORICO | Phiên bản 2.1.0</p>
        </div>
    </main>

    <script src="../assets/js/admin_actions.js"></script>
    <script>
      // Load sản phẩm từ localStorage
      let products = JSON.parse(localStorage.getItem('morico_products')) || [];
      
      // Hiển thị danh sách sản phẩm với giá
      function renderPricingTable() {
        const tbody = document.getElementById('pricing-table-body');
        tbody.innerHTML = '';
        
        if (products.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;">Chưa có sản phẩm nào</td></tr>';
          return;
        }
        
        products.forEach((product, index) => {
          const profitMargin = product.profitMargin || 0;
          const sellingPrice = calculateSellingPrice(product.cost || 0, profitMargin);
          const categoryName = getCategoryName(product.category);
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${product.name} <span style="font-size: 0.85rem; color: #9E9E9E;">(${product.code})</span></td>
            <td>${categoryName}</td>
            <td style="text-align:right; color: #D32F2F;">${formatPrice(product.cost || 0)}</td>
            <td style="text-align:center;">
              <input type="number" class="profit-input" value="${profitMargin}" min="0" max="200" step="0.5" 
                     data-product-id="${product.id}" onchange="updatePrice(this)">
            </td>
            <td style="text-align:right;"><span style="font-weight: bold;" id="price-${product.id}">${formatPrice(sellingPrice)}</span></td>
            <td class="action-group" style="justify-content:center;">
              <button class="btn-show btn-action-small" onclick="savePrice(${product.id})"><i class="fas fa-save"></i> Lưu</button>
              <button class="btn-secondary btn-action-small" onclick="resetPrice(${product.id})"><i class="fas fa-undo"></i> Reset</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }
      
      // Tính giá bán dựa trên giá vốn và % lợi nhuận
      function calculateSellingPrice(cost, profitMargin) {
        return Math.round(cost * (1 + profitMargin / 100));
      }
      
      // Format giá tiền
      function formatPrice(price) {
        return price.toLocaleString('vi-VN') + 'đ';
      }
      
      // Lấy tên danh mục
      function getCategoryName(category) {
        const categoryMap = {
          'ngot': 'Bánh Ngọt',
          'man': 'Bánh Mặn',
          'chay': 'Bánh Chay'
        };
        return categoryMap[category] || category;
      }
      
      // Cập nhật giá bán khi thay đổi % lợi nhuận
      function updatePrice(input) {
        const productId = parseInt(input.dataset.productId);
        const product = products.find(p => p.id === productId);
        
        if (product) {
          const profitMargin = parseFloat(input.value) || 0;
          const sellingPrice = calculateSellingPrice(product.cost || 0, profitMargin);
          document.getElementById(`price-${productId}`).textContent = formatPrice(sellingPrice);
        }
      }
      
      // Lưu giá
      function savePrice(productId) {
        const product = products.find(p => p.id === productId);
        const input = document.querySelector(`input[data-product-id="${productId}"]`);
        
        if (product && input) {
          const profitMargin = parseFloat(input.value) || 0;
          product.profitMargin = profitMargin;
          product.price = calculateSellingPrice(product.cost || 0, profitMargin);
          
          // Lưu vào localStorage
          localStorage.setItem('morico_products', JSON.stringify(products));
          
          alert(`✅ Đã lưu giá bán cho ${product.name}: ${formatPrice(product.price)}`);
        }
      }
      
      // Reset về % lợi nhuận ban đầu
      function resetPrice(productId) {
        const product = products.find(p => p.id === productId);
        const input = document.querySelector(`input[data-product-id="${productId}"]`);
        
        if (product && input) {
          input.value = product.profitMargin || 0;
          updatePrice(input);
        }
      }
      
      // Load dữ liệu khi trang tải
      document.addEventListener('DOMContentLoaded', function() {
        renderPricingTable();
      });
    </script>
  </body>
</html>