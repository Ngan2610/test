<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh To√°n ƒê∆°n H√†ng - MORICO</title>
    <link rel="stylesheet" href="../assets/external/cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --brand-gold: #E6BE8A;
            --brand-crimson: #8B0000;
            --bg-cream: #FFF8E7;
            --muted-brown: #5D4037;
            --card-white: #ffffff;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(to right, #FFFDF2, #FFF9DC, #FFF4C2);
            color: #8B0000;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo i {
            font-size: 2.5rem;
            color: var(--brand-crimson);
        }

        .logo-text {
            font-size: 2rem;
            font-weight: 800;
            color: var(--brand-crimson);
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--brand-crimson);
            font-weight: 700;
        }

        .subtitle {
            text-align: center;
            color: var(--muted-brown);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        #checkout-container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: var(--card-white);
            border: 2px solid var(--brand-crimson);
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(139, 0, 0, 0.15);
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .section {
            padding: 25px;
            border-radius: 12px;
            background-color: var(--bg-cream);
            margin-bottom: 20px;
            border: 1px solid var(--brand-gold);
            box-shadow: 0 4px 15px rgba(230, 190, 138, 0.2);
        }

        h2 {
            font-size: 1.5rem;
            border-bottom: 2px solid var(--brand-gold);
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: var(--muted-brown);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h2 i {
            color: var(--brand-crimson);
        }

        p {
            margin: 12px 0;
            color: var(--muted-brown);
            font-size: 1rem;
            line-height: 1.5;
        }

        strong {
            color: var(--brand-crimson);
        }

        #order-summary {
            grid-column: 2;
            grid-row: 1 / span 2;
        }

        #items-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--brand-gold);
            font-size: 1rem;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-info {
            color: var(--muted-brown);
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: var(--brand-crimson);
        }

        .item-quantity {
            color: var(--muted-brown);
            font-size: 0.9rem;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 15px 0;
            margin-top: 15px;
            border-top: 2px solid var(--brand-crimson);
        }

        .total-amount {
            color: var(--brand-crimson) !important;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .shipping-free {
            color: #2E7D32 !important;
            font-weight: 600;
        }

        .payment-option {
            margin: 15px 0;
            font-size: 1rem;
            padding: 12px;
            border-radius: 8px;
            background: white;
            border: 1px solid var(--brand-gold);
            transition: all 0.3s ease;
        }

        .payment-option:hover {
            background: var(--bg-cream);
            border-color: var(--brand-crimson);
        }

        .payment-option input {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .payment-option label {
            font-weight: 600;
            color: var(--muted-brown);
            cursor: pointer;
        }

        .confirm-btn {
            display: block;
            width: 100%;
            padding: 18px;
            margin-top: 30px;
            background: linear-gradient(135deg, var(--brand-crimson) 0%, #6a0000 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.3rem;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.3);
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 0, 0, 0.4);
            background: linear-gradient(135deg, #6a0000 0%, var(--brand-crimson) 100%);
        }

        .confirm-btn:active {
            transform: translateY(0);
        }

        #customer-info {
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        #customer-info label {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--brand-crimson);
            font-size: 1rem;
        }

        #customer-info input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--brand-gold);
            border-radius: 8px;
            font-size: 1rem;
            color: var(--muted-brown);
            background: white;
            transition: all 0.3s ease;
        }

        #customer-info input:focus {
            outline: none;
            border-color: var(--brand-crimson);
            box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
        }

        #transfer-options {
            padding: 20px;
            border: 2px dashed var(--brand-gold);
            margin-top: 15px;
            background-color: var(--card-white);
            border-radius: 10px;
            display: none;
        }

        .back-to-cart {
            text-align: center;
            margin-top: 20px;
        }

        .back-link {
            color: var(--brand-crimson);
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease;
        }

        .back-link:hover {
            color: var(--muted-brown);
            text-decoration: underline;
        }

        /* Style cho ph·∫ßn ƒë·ªãa ch·ªâ */
        .address-section {
            margin-top: 20px;
        }

        .address-option {
            margin: 15px 0;
            padding: 15px;
            border: 2px solid var(--brand-gold);
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .address-option:hover {
            border-color: var(--brand-crimson);
            background: var(--bg-cream);
        }

        .address-option.selected {
            border-color: var(--brand-crimson);
            background: var(--bg-cream);
            box-shadow: 0 0 0 2px rgba(139, 0, 0, 0.2);
        }

        .address-option input {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .address-label {
            font-weight: 700;
            color: var(--brand-crimson);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .address-details {
            color: var(--muted-brown);
            font-size: 0.95rem;
            margin-left: 25px;
            line-height: 1.4;
        }

        .address-contact {
            color: var(--muted-brown);
            font-size: 0.9rem;
            margin-left: 25px;
            margin-top: 5px;
        }

        .delete-address-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            color: var(--muted-brown);
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: bold;
        }

        .delete-address-btn:hover {
            color: var(--brand-crimson);
            background: rgba(139, 0, 0, 0.1);
        }

        .add-address-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: transparent;
            color: var(--brand-crimson);
            border: 2px dashed var(--brand-crimson);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-address-btn:hover {
            background: rgba(139, 0, 0, 0.05);
            border-style: solid;
        }

        .new-address-form {
            margin-top: 20px;
            padding: 20px;
            border: 2px solid var(--brand-gold);
            border-radius: 10px;
            background: white;
            display: none;
        }

        .new-address-form h3 {
            color: var(--brand-crimson);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .save-address-btn {
            flex: 1;
            padding: 10px;
            background: var(--brand-crimson);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .save-address-btn:hover {
            background: #6a0000;
        }

        .cancel-address-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            color: var(--muted-brown);
            border: 1px solid var(--muted-brown);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .cancel-address-btn:hover {
            background: rgba(93, 64, 55, 0.1);
        }

        @media (max-width: 768px) {
            #checkout-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            #order-summary {
                grid-column: 1;
                grid-row: auto;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .address-option {
                padding: 12px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .delete-address-btn {
                top: 5px;
                right: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <i class="fas fa-moon"></i>
            <div class="logo-text">MORICO</div>
        </div>
        <h1>THANH TO√ÅN ƒê∆†N H√ÄNG</h1>
        <div class="subtitle">Ho√†n t·∫•t ƒë∆°n h√†ng c·ªßa b·∫°n m·ªôt c√°ch d·ªÖ d√†ng v√† an to√†n</div>
    </div>

    <div id="checkout-container">
        <div id="shipping-info" class="section">
            <h2><i class="fas fa-user"></i> Th√¥ng tin Kh√°ch h√†ng</h2>
            
            <div id="customer-info">
                <div class="form-group">
                    <label for="customer-name">H·ªç v√† T√™n:</label>
                    <input type="text" id="customer-name" placeholder="Nh·∫≠p h·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n">
                </div>
                <div class="form-group">
                    <label for="customer-phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                    <input type="text" id="customer-phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                </div>
                
                <div class="address-section">
                    <h2><i class="fas fa-map-marker-alt"></i> ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</h2>
                    
                    <div id="address-options">
                        <!-- ƒê·ªãa ch·ªâ s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript -->
                    </div>
                    
                    <button class="add-address-btn" id="add-address-btn">
                        <i class="fas fa-plus"></i> Th√™m ƒë·ªãa ch·ªâ m·ªõi
                    </button>
                    
                    <div class="new-address-form" id="new-address-form">
                        <h3><i class="fas fa-home"></i> Th√™m ƒë·ªãa ch·ªâ m·ªõi</h3>
                        <div class="form-group">
                            <label for="new-address-name">T√™n ng∆∞·ªùi nh·∫≠n:</label>
                            <input type="text" id="new-address-name" placeholder="Nh·∫≠p h·ªç t√™n ng∆∞·ªùi nh·∫≠n">
                        </div>
                        <div class="form-group">
                            <label for="new-address-phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                            <input type="text" id="new-address-phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                        </div>
                        <div class="form-group">
                            <label for="street">S·ªë nh√†/T√™n ƒë∆∞·ªùng:</label>
                            <input type="text" id="street" placeholder="V√≠ d·ª•: 123 ƒê∆∞·ªùng ABC">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ward">Ph∆∞·ªùng/X√£:</label>
                                <input type="text" id="ward" placeholder="V√≠ d·ª•: Ph∆∞·ªùng 1">
                            </div>
                            <div class="form-group">
                                <label for="district">Qu·∫≠n/Huy·ªán:</label>
                                <input type="text" id="district" placeholder="V√≠ d·ª•: Qu·∫≠n 1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="city">T·ªânh/Th√†nh ph·ªë:</label>
                            <input type="text" id="city" placeholder="V√≠ d·ª•: H√† N·ªôi">
                        </div>
                        <div class="form-actions">
                            <button class="save-address-btn" id="save-address-btn">L∆∞u ƒë·ªãa ch·ªâ</button>
                            <button class="cancel-address-btn" id="cancel-address-btn">H·ªßy</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="order-summary" class="section">
            <h2><i class="fas fa-receipt"></i> Chi ti·∫øt ƒê∆°n h√†ng</h2>
            <ul id="items-list"></ul>
            
            <div class="total-row">
                <span>T·ªïng ti·ªÅn h√†ng:</span>
                <span class="total-amount" id="sub-total">0‚Ç´</span>
            </div> 
            
            <div class="total-row" style="border-top: none; padding-top: 10px;">
                <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                <span class="shipping-free">Mi·ªÖn ph√≠</span>
            </div>
            
            <div class="total-row" style="border-top: 2px solid var(--brand-crimson); margin-top: 10px;">
                <span>T·ªîNG THANH TO√ÅN:</span>
                <span class="total-amount" id="final-total">0‚Ç´</span>
            </div>

            <div style="margin-top: 30px;">
                <h2><i class="fas fa-credit-card"></i> H√¨nh th·ª©c Thanh to√°n</h2>
                <div class="payment-option">
                    <input type="radio" name="payment-method" id="cod" value="COD" checked>
                    <label for="cod">Thanh to√°n khi nh·∫≠n h√†ng (COD)</label>
                </div>
                <div class="payment-option">
                    <input type="radio" name="payment-method" id="transfer" value="Transfer">
                    <label for="transfer">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
                </div>
                
                <div id="transfer-options">
                    <p style="margin-bottom: 15px; font-weight: bold; color: var(--brand-crimson);">
                        <i class="fas fa-university"></i> Ch·ªçn Ng√¢n h√†ng/V√≠ ƒëi·ªán t·ª≠:
                    </p>
                    <div class="payment-option">
                        <input type="radio" name="transfer-detail" id="momo" value="Momo" checked>
                        <label for="momo">V√≠ ƒëi·ªán t·ª≠ MoMo</label>
                    </div>
                    <div class="payment-option">
                        <input type="radio" name="transfer-detail" id="vcb" value="Vietcombank">
                        <label for="vcb">Ng√¢n h√†ng Vietcombank (VCB)</label>
                    </div>
                    <div class="payment-option">
                        <input type="radio" name="transfer-detail" id="techcombank" value="Sacombank">
                        <label for="techcombank">Ng√¢n h√†ng Sacombank</label>
                    </div>
                </div>
            </div>

            <button class="confirm-btn" onclick="confirmOrder()">
                <i class="fas fa-check-circle"></i> X√ÅC NH·∫¨N ƒê·∫∂T H√ÄNG
            </button>
            
            <div class="back-to-cart">
                <a href="cart.html" class="back-link">
                    <i class="fas fa-arrow-left"></i> Quay l·∫°i gi·ªè h√†ng
                </a>
            </div>
        </div>
    </div>

    <script>
        // Bi·∫øn to√†n c·ª•c
        const allCartItems = JSON.parse(localStorage.getItem("cart")) || [];
        const itemsToCheckout = JSON.parse(localStorage.getItem("checkout_items")) || [];
        const user = JSON.parse(localStorage.getItem("currentUser"));
        
        const itemsList = document.getElementById("items-list");
        const finalTotalSpan = document.getElementById("final-total");
        const subTotalSpan = document.getElementById("sub-total");
        const SHIPPING_FEE = 0;
        let orderSubTotal = 0;
        let selectedAddress = null;
        let userAddresses = [];

        // === C√ÅC H√ÄM QU·∫¢N L√ù ƒê∆†N H√ÄNG ===
        function getAllOrders() {
            const orders = localStorage.getItem('orders');
            return orders ? JSON.parse(orders) : [];
        }

        function addNewOrder(order) {
            const orders = getAllOrders();
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));
            return order;
        }

        function generateOrderId() {
            const orders = getAllOrders();
            const lastOrder = orders[orders.length - 1];
            if (lastOrder && lastOrder.id.startsWith('ORD-')) {
                const lastNumber = parseInt(lastOrder.id.split('-')[1]);
                return `ORD-${(lastNumber + 1).toString().padStart(4, '0')}`;
            }
            return `ORD-${(orders.length + 1).toString().padStart(4, '0')}`;
        }

        function formatCurrency(amount) {
            return amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }

        // === H√ÄM L·∫§Y NG√ÄY HI·ªÜN T·∫†I ===
        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // === C√ÅC H√ÄM QU·∫¢N L√ù ƒê·ªäA CH·ªà ===
        function loadUserAddresses() {
            // LU√îN t·∫°o ƒë·ªãa ch·ªâ t·ª´ profile ƒë·∫ßu ti√™n
            userAddresses = [];
            
            if (user) {
                // T·∫°o ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh t·ª´ profile
                const profileAddress = {
                    id: 'profile',
                    name: 'ƒê·ªãa ch·ªâ m·∫∑c ƒë·ªãnh',
                    details: user.address && user.address.trim() !== '' ? user.address : 'Vui l√≤ng c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ trong h·ªì s∆°',
                    phone: user.phone || '',
                    contactName: user.fullname || '',
                    isDefault: true
                };
                userAddresses.push(profileAddress);
                
                // Load th√™m ƒë·ªãa ch·ªâ t·ª´ localStorage n·∫øu c√≥
                const savedAddresses = localStorage.getItem('userAddresses');
                if (savedAddresses) {
                    const additionalAddresses = JSON.parse(savedAddresses);
                    userAddresses = userAddresses.concat(additionalAddresses);
                }
            }
            
            saveUserAddresses();
            renderAddressOptions();
        }

        function saveUserAddresses() {
            // Ch·ªâ l∆∞u c√°c ƒë·ªãa ch·ªâ kh√¥ng ph·∫£i t·ª´ profile
            const addressesToSave = userAddresses.filter(addr => addr.id !== 'profile');
            localStorage.setItem('userAddresses', JSON.stringify(addressesToSave));
        }

        function deleteAddress(addressId) {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë·ªãa ch·ªâ n√†y?')) {
                // Kh√¥ng cho x√≥a ƒë·ªãa ch·ªâ t·ª´ profile
                if (addressId === 'profile') {
                    alert('Kh√¥ng th·ªÉ x√≥a ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh t·ª´ h·ªì s∆°!');
                    return;
                }
                
                // X√≥a ƒë·ªãa ch·ªâ
                userAddresses = userAddresses.filter(addr => addr.id !== addressId);
                
                // N·∫øu ƒë·ªãa ch·ªâ b·ªã x√≥a l√† ƒë·ªãa ch·ªâ ƒëang ƒë∆∞·ª£c ch·ªçn, ch·ªçn ƒë·ªãa ch·ªâ profile
                if (selectedAddress && selectedAddress.id === addressId) {
                    selectedAddress = userAddresses.find(addr => addr.id === 'profile');
                    if (selectedAddress) {
                        selectedAddress.isDefault = true;
                    }
                }
                
                saveUserAddresses();
                renderAddressOptions();
                alert('ƒê√£ x√≥a ƒë·ªãa ch·ªâ th√†nh c√¥ng!');
            }
        }

        function renderAddressOptions() {
            const addressOptionsContainer = document.getElementById('address-options');
            addressOptionsContainer.innerHTML = '';
            
            if (userAddresses.length === 0) {
                addressOptionsContainer.innerHTML = '<p style="color: var(--muted-brown); text-align: center;">Ch∆∞a c√≥ ƒë·ªãa ch·ªâ n√†o. Vui l√≤ng th√™m ƒë·ªãa ch·ªâ m·ªõi.</p>';
                selectedAddress = null;
                return;
            }
            
            userAddresses.forEach(address => {
                const addressOption = document.createElement('div');
                addressOption.className = 'address-option';
                if (address.isDefault) {
                    addressOption.classList.add('selected');
                    selectedAddress = address;
                }
                
                addressOption.innerHTML = `
                    <div>
                        <input type="radio" name="address" value="${address.id}" ${address.isDefault ? 'checked' : ''}>
                        <span class="address-label">
                            ${address.name}
                            ${address.id === 'profile' ? '<i class="fas fa-user" style="color: var(--brand-crimson);"></i>' : ''}
                        </span>
                        <div class="address-details">${address.details}</div>
                        <div class="address-contact">
                            ${address.contactName ? address.contactName + ' ‚Ä¢ ' : ''}${address.phone || ''}
                        </div>
                    </div>
                    ${address.id !== 'profile' ? 
                        `<button class="delete-address-btn" onclick="deleteAddress('${address.id}')" title="X√≥a ƒë·ªãa ch·ªâ">
                            √ó
                        </button>` 
                        : ''
                    }
                `;
                
                addressOption.querySelector('input').addEventListener('change', function() {
                    if (this.checked) {
                        document.querySelectorAll('.address-option').forEach(option => {
                            option.classList.remove('selected');
                        });
                        addressOption.classList.add('selected');
                        selectedAddress = address;
                        
                        // C·∫≠p nh·∫≠t th√¥ng tin kh√°ch h√†ng khi ch·ªçn ƒë·ªãa ch·ªâ
                        if (address.contactName) {
                            document.getElementById('customer-name').value = address.contactName;
                        }
                        if (address.phone) {
                            document.getElementById('customer-phone').value = address.phone;
                        }
                    }
                });
                
                addressOptionsContainer.appendChild(addressOption);
            });
        }

        function showNewAddressForm() {
            document.getElementById('new-address-form').style.display = 'block';
            document.getElementById('add-address-btn').style.display = 'none';
            
            // ƒêi·ªÅn th√¥ng tin m·∫∑c ƒë·ªãnh t·ª´ form ch√≠nh
            const currentName = document.getElementById('customer-name').value;
            const currentPhone = document.getElementById('customer-phone').value;
            
            if (currentName) {
                document.getElementById('new-address-name').value = currentName;
            }
            if (currentPhone) {
                document.getElementById('new-address-phone').value = currentPhone;
            }
        }

        function hideNewAddressForm() {
            document.getElementById('new-address-form').style.display = 'none';
            document.getElementById('add-address-btn').style.display = 'flex';
            document.getElementById('new-address-name').value = '';
            document.getElementById('new-address-phone').value = '';
            document.getElementById('street').value = '';
            document.getElementById('ward').value = '';
            document.getElementById('district').value = '';
            document.getElementById('city').value = '';
        }

        function saveNewAddress() {
            const name = document.getElementById('new-address-name').value.trim();
            const phone = document.getElementById('new-address-phone').value.trim();
            const street = document.getElementById('street').value.trim();
            const ward = document.getElementById('ward').value.trim();
            const district = document.getElementById('district').value.trim();
            const city = document.getElementById('city').value.trim();
            
            // Validate th√¥ng tin
            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n.');
                return;
            }
            if (!phone) {
                alert('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i.');
                return;
            }
            if (!street) {
                alert('Vui l√≤ng nh·∫≠p s·ªë nh√†/t√™n ƒë∆∞·ªùng.');
                return;
            }
            if (!ward) {
                alert('Vui l√≤ng nh·∫≠p ph∆∞·ªùng/x√£.');
                return;
            }
            if (!district) {
                alert('Vui l√≤ng nh·∫≠p qu·∫≠n/huy·ªán.');
                return;
            }
            if (!city) {
                alert('Vui l√≤ng nh·∫≠p t·ªânh/th√†nh ph·ªë.');
                return;
            }
            
            // Validate s·ªë ƒëi·ªán tho·∫°i
            if (!/^\d{10,11}$/.test(phone)) {
                alert('S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10-11 ch·ªØ s·ªë!');
                return;
            }

            const newId = 'addr_' + Date.now();
            
            // T·∫°o ƒë·ªãa ch·ªâ chi ti·∫øt
            const fullAddress = `${street}, ${ward}, ${district}, ${city}`;
            
            userAddresses.push({
                id: newId,
                name: 'ƒê·ªãa ch·ªâ m·ªõi',
                details: fullAddress,
                phone: phone,
                contactName: name,
                isDefault: false
            });
            
            saveUserAddresses();
            renderAddressOptions();
            hideNewAddressForm();
            
            alert('ƒê√£ th√™m ƒë·ªãa ch·ªâ m·ªõi th√†nh c√¥ng!');
        }

        // === C√ÅC H√ÄM X·ª¨ L√ù GIAO DI·ªÜN ===
        function loadUserInfo() {
            if (!user) {
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-phone').value = '';
                return;
            }
            
            // Lu√¥n ƒëi·ªÅn th√¥ng tin t·ª´ profile
            document.getElementById('customer-name').value = user.fullname || '';
            document.getElementById('customer-phone').value = user.phone || '';
        }

        function loadOrderDetails() {
            if (itemsToCheckout.length === 0) {
                alert("Gi·ªè h√†ng kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ thanh to√°n.");
                window.location.href = "cart.html"; 
                return;
            }
            
            let html = "";
            orderSubTotal = 0;
            
            itemsToCheckout.forEach(item => {
                const totalPrice = item.price * item.quantity;
                orderSubTotal += totalPrice;
                html += `
                    <li class="order-item">
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-quantity">S·ªë l∆∞·ª£ng: ${item.quantity}</div>
                        </div>
                        <span style="font-weight: bold; color: var(--brand-crimson);">
                            ${formatCurrency(totalPrice)}
                        </span>
                    </li>
                `;
            });
            
            itemsList.innerHTML = html;
            subTotalSpan.textContent = formatCurrency(orderSubTotal);
            finalTotalSpan.textContent = formatCurrency(orderSubTotal + SHIPPING_FEE);
        }

        function toggleTransferOptions() {
            const isTransfer = document.getElementById('transfer').checked;
            document.getElementById('transfer-options').style.display = isTransfer ? 'block' : 'none';
        }

        // === H√ÄM X√ÅC NH·∫¨N ƒê∆†N H√ÄNG ===
        function confirmOrder() {
            if (itemsToCheckout.length === 0) {
                alert("Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn. Vui l√≤ng quay l·∫°i gi·ªè h√†ng.");
                return;
            }

            const customerName = document.getElementById('customer-name').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();

            if (!customerName) {
                alert("Vui l√≤ng nh·∫≠p h·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n.");
                return;
            }
            if (!customerPhone) {
                alert("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i.");
                return;
            }
            if (!selectedAddress) {
                alert("Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ nh·∫≠n h√†ng.");
                return;
            }

            const finalTotal = orderSubTotal + SHIPPING_FEE;
            let paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
            if (paymentMethod === 'Transfer') {
                const transferDetail = document.querySelector('input[name="transfer-detail"]:checked').value;
                paymentMethod = `Chuy·ªÉn kho·∫£n (${transferDetail})`;
            }

            const orderId = generateOrderId();
            const today = getCurrentDate();
            
            const confirmationMessage = `B·∫°n x√°c nh·∫≠n ƒë·∫∑t h√†ng v·ªõi chi ti·∫øt:\n\nM√£ ƒë∆°n h√†ng: ${orderId}\nNg√†y ƒë·∫∑t: ${today}\nNg∆∞·ªùi nh·∫≠n: ${customerName}\nS·ªë ƒëi·ªán tho·∫°i: ${customerPhone}\nƒê·ªãa ch·ªâ: ${selectedAddress.details}\nT·ªïng ti·ªÅn: ${formatCurrency(finalTotal)}\nH√¨nh th·ª©c thanh to√°n: ${paymentMethod}\n\nB·∫•m OK ƒë·ªÉ x√°c nh·∫≠n ƒë·∫∑t h√†ng.`;

            if (confirm(confirmationMessage)) {
                const newOrder = {
                    id: orderId,
                    customer: customerName,
                    phone: customerPhone,
                    address: selectedAddress.details,
                    total: finalTotal,
                    status: 'pending',
                    date: today,
                    paymentMethod: paymentMethod,
                    products: itemsToCheckout.map(item => ({ 
                        name: item.name, 
                        quantity: item.quantity, 
                        price: item.price, 
                        total: item.price * item.quantity 
                    }))
                };

                addNewOrder(newOrder);

                let history = JSON.parse(localStorage.getItem("purchaseHistory")) || [];
                history.unshift(newOrder);
                localStorage.setItem("purchaseHistory", JSON.stringify(history));

                const newCartItems = allCartItems.filter(cartItem => {
                    return !itemsToCheckout.some(checkoutItem => 
                        checkoutItem.id === cartItem.id);
                });

                localStorage.removeItem("checkout_items");
                localStorage.setItem("cart", JSON.stringify(newCartItems));

                alert(`üéâ ƒê∆°n h√†ng ${orderId} ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n th√†nh c√¥ng!\n\nC·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng t·∫°i MORICO. ƒê∆°n h√†ng c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω trong th·ªùi gian s·ªõm nh·∫•t.`);
                window.location.href = "history.html";
            }  
        }

        // Kh·ªüi t·∫°o trang
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadOrderDetails();
            loadUserAddresses();
            
            document.getElementById('transfer').addEventListener('change', toggleTransferOptions);
            document.getElementById('cod').addEventListener('change', toggleTransferOptions);
            document.getElementById('add-address-btn').addEventListener('click', showNewAddressForm);
            document.getElementById('save-address-btn').addEventListener('click', saveNewAddress);
            document.getElementById('cancel-address-btn').addEventListener('click', hideNewAddressForm);
            
            toggleTransferOptions();
        });
    </script>
</body>
</html>