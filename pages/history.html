<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <title>Lịch Sử Mua Hàng</title>
    <style>
        /* styles.css - CSS chung cho toàn bộ website */
        body {
            margin: 0;
            font-family: "Century", serif; 
            background: linear-gradient(to right, #FFFDF2, #FFF9DC, #FFF4C2);
            color: #8B0000;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 18px;
        }

        /* ===== HEADER CHÍNH ===== */
        header {
            background-color: #ffffff;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            height: auto; 
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            padding: 0 30px;
            gap: 20px;
        }

        /* LOGO */
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Dancing Script', cursive;
            font-size: 48px;
            font-weight: bold;
            color: #8B0000;
        }

        .logo-img {
            height: 60px;
            width: auto;
        }

        /* ICON */
        .icon-group {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .icon-link {
            position: relative;
        }
        
        .icon-link svg,
        .user-icon {
            width: 34px;
            height: 34px;
            fill: #8B0000;
            cursor: pointer;
            transition: transform 0.3s, fill 0.3s;
        }

        /* TIÊU ĐỀ TRANG */
        .page-title {
            font-size: 32px;
            color: #8B0000;
            padding: 15px 20px;
            font-family: 'Dancing Script', cursive;
            font-weight: 700;
            text-align: center;
            background-color: #FFFFFF; 
            border-bottom: none; 
            margin: 0; 
        }
        
        /* ===== THANH MENU PHÍA DƯỚI (NAV-BAR) ===== */
        .nav-bar {
            display: flex;
            justify-content: center;
            background-color: #FFFBE6;
            padding: 15px 0;
            border-top: 1px solid #8B0000;
            border-bottom: 1.5px solid #8B0000;
            gap: 40px;
        }

        .nav-bar a {
            color: #5a2d0c;
            text-decoration: none;
            font-size: 22px;
            font-weight: 600;
        }

        .nav-bar a:hover {
            color: #8B0000;
            text-decoration: underline;
        }

        /* THANH TÌM KIẾM */
        .search-bar {
            display: flex;
            align-items: center;
            width: 650px;
            background-color: #FFFCF5;
            border: 2px solid #8B0000;
            border-radius: 40px;
            padding: 6px 12px;
            position: relative;
        }

        .search-bar input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 20px;
            padding: 10px 16px;
            color: #333;
        }

        .search-bar button {
            background-color: #8B0000;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.3s;
        }

        .search-bar button svg {
            width: 22px;
            height: 22px;
            fill: #fff;
        }

        .search-bar button:hover {
            background-color: #b22222;
            transform: scale(1.05);
        }

        /* MENU NGƯỜI DÙNG */
        .user-menu {
            position: relative;
        }

        .dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 45px;
            background-color: #fffdf0;
            border: 1.5px solid #8B0000;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 100;
            text-align: center;
        }

        .dropdown a {
            display: block;
            color: #8B0000;
            text-decoration: none;
            padding: 12px 0;
            font-family: "Century", serif;
            font-size: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .dropdown a:hover {
            background-color: #FFDAB9;
            color: #B22222;
        }

        .dropdown.active {
            display: block;
        }

        /* BADGE ĐẾM SỐ LƯỢNG GIỎ HÀNG */
        .cart-count {
            position: absolute;
            top: -10px;
            right: -12px;
            background-color: #B22222;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            border: 1px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.2s, transform 0.2s;
        }

        .cart-count.visible {
            opacity: 1;
            transform: scale(1);
        }

        /* KẾT QUẢ TÌM KIẾM */
        .search-results {
            position: absolute;
            top: 75px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            background-color: #fffdf0;
            border: 1.5px solid #8B0000;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 2000;
        }

        .search-results.active {
            display: block;
        }

        .search-results .product-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f3d6c1;
            transition: background-color 0.3s;
            cursor: pointer;
        }

        .search-results .product-item:hover {
            background-color: #ffe4b5;
        }

        .search-results img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            margin-right: 10px;
        }

        .search-results h4 {
            margin: 0;
            font-size: 18px;
            color: #8B0000;
            font-family: "Century", serif;
        }

        .search-results p {
            margin: 2px 0 0;
            font-size: 16px;
            color: #5a2d0c;
        }

        #history-container {
            padding: 220px 30px 50px;
            max-width: 1100px;
            margin: 20px auto;
        }

        /* THIẾT KẾ CHO ORDER-CARD */
        .order-card {
            background-color: #fffdf0;
            border: 2px solid #8B0000;
            border-radius: 18px;
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 35px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(139, 0, 0, 0.15);
        }

        .order-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(to right, #8B0000, #FFDAB9);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px dashed #B22222;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }

        .order-header h2 {
            margin: 0;
            font-size: 28px;
            color: #5a2d0c;
            font-weight: 700;
        }

        .order-header span {
            font-size: 20px;
            font-weight: bold;
            color: #8B0000;
            background-color: #FFEBCD;
            padding: 8px 16px;
            border-radius: 25px;
        }

        .order-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .order-details p {
            margin: 8px 0;
            font-size: 20px;
            color: #5a2d0c;
            line-height: 1.5;
        }

        .order-details strong {
            color: #8B0000;
            font-size: 21px;
        }

        .item-list {
            list-style: none;
            padding-left: 0;
            margin-top: 15px;
            border-top: 2px dotted #B22222;
            padding-top: 20px;
        }

        .item-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 20px;
            color: #5a2d0c;
            padding: 10px 0;
            border-bottom: 2px solid #FFEBCD;
        }

        .item-list li:last-child {
            border-bottom: none;
        }

        .item-name {
            flex: 1;
            font-size: 21px;
        }

        .item-quantity {
            margin: 0 20px;
            color: #8B0000;
            font-weight: bold;
            font-size: 21px;
        }

        .item-price {
            font-weight: bold;
            color: #8B0000;
            font-size: 21px;
        }

        .total-info {
            font-size: 26px;
            font-weight: bold;
            text-align: right;
            margin-top: 25px;
            color: #8B0000;
            padding-top: 20px;
            border-top: 3px dashed #B22222;
        }

        #empty-message {
            text-align: center;
            font-size: 28px;
            color: #B22222;
            padding: 60px;
        }

        .status-badge {
            padding: 0.3em 0.8em;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.75rem;
            margin-left: 10px;
        }
        .status-badge.pending {background-color: #FFEBEE; color: #C62828;}
        .status-badge.confirmed {background-color: #FFF3E0; color: #EF6C00;}
        .status-badge.shipping {background-color: #E3F2FD; color: #1E88E5;}
        .status-badge.delivered {background-color: #E8F5E9; color: #2E7D32;}
        .status-badge.cancelled {background-color: #ECEFF1; color: #455A64;}

        /* Responsive */
        @media (max-width: 1200px) {
            .header-container {
                padding: 0 20px;
                gap: 15px;
            }
            
            .search-bar {
                width: 500px;
            }
        }

        @media (max-width: 992px) {
            .header-container {
                height: auto;
                padding: 10px 20px;
                flex-wrap: wrap;
            }
            
            .logo {
                font-size: 36px;
                margin-bottom: 10px;
            }
            
            .logo-img {
                height: 45px;
            }
            
            .search-bar {
                width: 100%;
                max-width: 500px;
                margin: 10px 0;
            }
            
            .icon-group {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            
            .nav-bar {
                flex-wrap: wrap;
                gap: 20px;
                padding: 10px 0;
            }
            
            .search-results {
                width: 90%;
                max-width: 500px;
            }
        }

        @media (max-width: 768px) {
            body {
                font-size: 16px;
            }
            
            .order-details {
                grid-template-columns: 1fr;
            }
            
            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-container {
                flex-direction: column;
                height: auto;
                padding: 15px;
            }
            
            .search-bar {
                width: 100%;
                max-width: 500px;
                margin: 10px 0;
            }
            
            .nav-bar {
                flex-wrap: wrap;
                gap: 20px;
            }
            
            .search-results {
                width: 95%;
                max-width: 400px;
                top: 70px;
            }
            
            .search-results .product-item {
                padding: 8px;
            }
            
            .search-results img {
                width: 50px;
                height: 50px;
            }
            
            .search-results h4 {
                font-size: 16px;
            }
            
            .search-results p {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .header-container {
                padding: 5px 10px;
            }
            
            .logo {
                font-size: 28px;
            }
            
            .logo-img {
                height: 35px;
            }
            
            .search-bar {
                padding: 3px 8px;
            }
            
            .search-bar input {
                font-size: 13px;
                padding: 5px 10px;
            }
            
            .search-bar button {
                width: 32px;
                height: 32px;
            }
            
            .icon-group {
                gap: 15px;
            }
            
            .icon-link svg,
            .user-icon {
                width: 24px;
                height: 24px;
            }
            
            .nav-bar {
                gap: 10px;
            }
            
            .nav-bar a {
                font-size: 15px;
            }
            
            .cart-count {
                width: 18px;
                height: 18px;
                font-size: 11px;
                top: -8px;
                right: -8px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class = "header-container">
            <div class = "logo">
                <img src = "../assets/image/login/logo.png" alt = "Logo Morico" class = "logo-img">
                <span>Morico</span>
            </div>
            <div class="search-bar">
                <input type="text" placeholder="Bạn muốn tìm bánh gì...">
                <button>
                    <svg xmlns="../assets/external/www.w3.org/2000/svg_file" viewBox="0 0 24 24">
                        <path d="M21.71 20.29l-3.387-3.387A8.958 8.958 0 0019 11a9 9 0 10-9 9 
                        8.958 8.958 0 005.903-1.677l3.387 3.387a1 1 0 001.414-1.414zM4 
                        11a7 7 0 1114 0 7 7 0 01-14 0z"/>
                    </svg>
                </button>
            </div>
            <div class="search-results"></div>
            <div class="icon-group">
                <a href="cart.html" class="icon-link" id="cartLink">
                    <svg xmlns="../assets/external/www.w3.org/2000/svg_file" viewBox="0 0 24 24">
                        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 
                        2-2-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2S15.9 22 17 22s2-.9 2-2-.9-2-2-2zM7.16 
                        14l.84-2h8.99c.89 0 1.67-.58 1.93-1.42l1.96-6.16A1 
                        1 0 0019 3H6.21l-.94-2H1v2h3l3.6 
                        7.59-1.35 3.32A1.99 1.99 0 006 17h12v-2H7.42a.5.5 0 
                        01-.47-.34L7.16 14z"/>
                    </svg>
                    <span id="cartCountBadge" class="cart-count">0</span>
                </a>
                <div class="user-menu">
                    <svg xmlns="../assets/external/www.w3.org/2000/svg_file" viewBox="0 0 24 24" class="user-icon" id="userIcon">
                        <path d="M12 12c2.7 0 4.9-2.2 
                        4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 
                        7.1 9.3 12 12 12zm0 2.4c-3.3 0-9.8 
                        1.7-9.8 4.9V22h19.6v-2.7c0-3.2-6.5-4.9-9.8-4.9z"/>
                    </svg>
                    <div class="dropdown" id="userDropdown">
                        <!-- Nội dung dropdown sẽ được thêm bằng JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        <nav class = "nav-bar">
            <a href = "../index.html">TRANG CHỦ</a>
            <a href = "about.html">GIỚI THIỆU</a> 
            <a href = "product.html">SẢN PHẨM</a>
        </nav>
        <h1 class="page-title"> LỊCH SỬ MUA HÀNG CỦA BẠN </h1>
    </header>
    
    <div id = "history-container">
        <p id = "empty-message" style = "display: none;">Bạn chưa có đơn hàng nào được xác nhận.</p>
    </div>

    <script>
        // --- KHAI BÁO BIẾN TOÀN CỤC ---
        const userIcon = document.getElementById("userIcon");
        const dropdown = document.getElementById("userDropdown");
        const cartCountBadge = document.getElementById("cartCountBadge");
        const cartLink = document.getElementById("cartLink");
        const historyContainer = document.getElementById("history-container");
        const emptyMessage = document.getElementById("empty-message");

        const statusMap = {
            'pending': { text: 'Chờ xác nhận', class: 'pending' },
            'confirmed': { text: 'Đã xác nhận', class: 'confirmed' },
            'shipping': { text: 'Đang giao hàng', class: 'shipping' },
            'delivered': { text: 'Đã giao thành công', class: 'delivered' },
            'cancelled': { text: 'Đã hủy', class: 'cancelled' },
        };

        function formatCurrency(amount) {
            return amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }

        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Cập nhật số lượng hiển thị trên icon giỏ hàng
         */
        function updateCartCount() {
            const currentUser = localStorage.getItem("currentUser");
            
            // CHỈ HIỆN GIỎ HÀNG KHI ĐÃ ĐĂNG NHẬP
            if (!currentUser) {
                cartLink.style.display = 'none';
                return;
            } else {
                cartLink.style.display = 'inline-block';
            }

            // 1. Lấy giỏ hàng từ localStorage
            const cart = JSON.parse(localStorage.getItem("cart")) || [];

            // 2. Tính tổng số lượng (dùng reduce)
            const totalCount = cart.reduce((sum, item) => sum + item.quantity, 0);

            // 3. Cập nhật giao diện
            if (totalCount > 0) {
                cartCountBadge.textContent = totalCount;
                cartCountBadge.classList.add("visible"); // Hiện badge
            } else {
                cartCountBadge.textContent = "0";
                cartCountBadge.classList.remove("visible"); // Ẩn badge
            }
        }

        /**
         * Cập nhật menu người dùng dựa trên trạng thái đăng nhập
         */
        function updateUserMenu() {
            const currentUserString = localStorage.getItem("currentUser");
            dropdown.innerHTML = ""; 

            if (currentUserString) {
                // --- TRƯỜNG HỢP: ĐÃ ĐĂNG NHẬP ---
                const currentUser = JSON.parse(currentUserString);
                dropdown.innerHTML = `
                    <a href="profile.html">Tài khoản</a>
                    <a href="#" id="logoutBtn">Đăng xuất</a>
                `;

                // Thêm sự kiện click cho link Tài Khoản
                const profileLink = dropdown.querySelector('a[href="profile.html"]');
                profileLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = 'profile.html';
                });

                document.getElementById("logoutBtn").addEventListener("click", e => {
                    e.preventDefault();
                    localStorage.removeItem("currentUser"); 
                    updateUserMenu(); 
                    updateCartCount(); // Cập nhật lại giỏ hàng khi logout
                    dropdown.classList.remove("active");
                });

            } else {
                // --- TRƯỜNG HỢP: CHƯA ĐĂNG NHẬP ---
                dropdown.innerHTML = `
                    <a href="login.html">Đăng nhập</a>
                    <a href="register.html">Đăng ký</a>
                `;
            }
        }

        function loadPurchaseHistory() {
            // Ưu tiên lấy dữ liệu từ purchaseHistory
            let purchaseHistory = JSON.parse(localStorage.getItem("purchaseHistory")) || [];
            
            console.log("Dữ liệu từ purchaseHistory:", purchaseHistory);
            
            // Nếu không có dữ liệu, thử lấy từ orders
            if (purchaseHistory.length === 0) {
                const allOrders = JSON.parse(localStorage.getItem("orders")) || [];
                console.log("Dữ liệu từ orders:", allOrders);
                
                // Lấy thông tin user hiện tại (nếu có)
                const currentUser = JSON.parse(localStorage.getItem("currentUser")) || {};
                const userPhone = currentUser.phone;
                
                if (userPhone) {
                    // Lọc đơn hàng theo số điện thoại của user
                    purchaseHistory = allOrders.filter(order => order.phone === userPhone);
                } else {
                    // Nếu không có thông tin user, hiển thị tất cả đơn hàng (cho demo)
                    purchaseHistory = allOrders;
                }
                
                // Lưu lại để lần sau dùng
                if (purchaseHistory.length > 0) {
                    localStorage.setItem("purchaseHistory", JSON.stringify(purchaseHistory));
                }
            }
            
            if (purchaseHistory.length === 0) {
                emptyMessage.style.display = 'block';
                historyContainer.appendChild(emptyMessage);
                return;
            }

            // Sắp xếp đơn hàng theo thời gian mới nhất
            purchaseHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

            let html = '';
            purchaseHistory.forEach(order => {
                const orderId = order.id || `ORD-${Math.floor(Math.random() * 10000)}`;
                const orderDate = order.date || getCurrentDate();
                const shippingAddress = order.address || order.shippingAddress || 'Chưa có thông tin';
                const paymentMethod = order.paymentMethod || 'Thanh toán khi nhận hàng (COD)';
                const orderTotal = order.total || 0;
                const customerName = order.customer || 'Chưa có thông tin';
                const customerPhone = order.phone || 'Chưa có thông tin';
                
                const products = order.products || order.items || [];
                const statusInfo = statusMap[order.status] || statusMap['pending'];
                
                const itemListHtml = products.map(item => `
                    <li>
                        <span class="item-name">${item.name || 'Sản phẩm'}</span>
                        <span class="item-quantity">x ${item.quantity || 1}</span>
                        <span class="item-price">${formatCurrency((item.price || 0) * (item.quantity || 1))}</span>
                    </li>
                `).join('');

                html += `
                    <div class="order-card">
                        <div class="order-header">
                            <h2>Đơn hàng: ${orderId}</h2>
                            <div>
                                <span>Ngày đặt: ${orderDate}</span>
                                <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>
                            </div>
                        </div>
                        <div class="order-details">
                            <div>
                                <p>Địa chỉ giao hàng: <strong>${shippingAddress}</strong></p>
                                <p>Hình thức thanh toán: <strong>${paymentMethod}</strong></p>
                            </div>
                            <div>
                                <p>Số điện thoại: <strong>${customerPhone}</strong></p>
                                <p>Khách hàng: <strong>${customerName}</strong></p>
                            </div>
                        </div>
                        <h3>Sản phẩm đã mua:</h3>
                        <ul class="item-list">
                            ${itemListHtml || '<li>Không có thông tin sản phẩm</li>'}
                        </ul>
                        <div class="total-info">
                            TỔNG TIỀN: ${formatCurrency(orderTotal)}
                        </div>
                    </div>
                `;
            });

            historyContainer.innerHTML = html;
        }

        // Tạo dữ liệu mẫu nếu không có dữ liệu
        function createSampleData() {
            const sampleOrders = [
                {
                    id: 'ORD-0001',
                    customer: 'Nguyễn Văn A',
                    phone: '0901234567',
                    address: '123 Đường ABC, Quận 1, TP.HCM',
                    total: 378000,
                    date: getCurrentDate(),
                    status: 'delivered',
                    paymentMethod: 'Thanh toán khi nhận hàng (COD)',
                    products: [
                        { name: 'Bánh Trung Thu Golden Plum', quantity: 2, price: 189000 }
                    ]
                },
                {
                    id: 'ORD-0002',
                    customer: 'Trần Thị B',
                    phone: '0912345678',
                    address: '456 Đường XYZ, Quận 3, TP.HCM',
                    total: 567000,
                    date: getCurrentDate(),
                    status: 'shipping',
                    paymentMethod: 'Chuyển khoản (Momo)',
                    products: [
                        { name: 'Bánh Trung Thu Hạt Sen', quantity: 1, price: 189000 },
                        { name: 'Bánh Trung Thu Thập Cẩm', quantity: 2, price: 189000 }
                    ]
                }
            ];
            
            localStorage.setItem("purchaseHistory", JSON.stringify(sampleOrders));
            localStorage.setItem("orders", JSON.stringify(sampleOrders));
        }

        // Tải lịch sử khi trang được mở
        document.addEventListener('DOMContentLoaded', function() {
            // 1. Cập nhật menu user ngay khi tải trang
            updateUserMenu();

            // 2. Cập nhật số lượng giỏ hàng
            updateCartCount();

            // 3. XỬ LÝ TÌM KIẾM
            const searchInput = document.querySelector('.search-bar input');
            const searchButton = document.querySelector('.search-bar button');
            const resultsBox = document.querySelector('.search-results');

            const products = [
                { id: 1, name: "Bánh Trung Thu Golden Plum", price: "189.000đ", image: "assets/image/product/banh-trung-thu-golden-plum.png" },
                { id: 2, name: "Bánh Trung Thu Hotate XO Mixed Nuts", price: "139.000đ", image: "assets/image/product/banh-trung-thu-hotate-xo-mixed-nuts.png" },
                { id: 3, name: "Bánh Trung Thu Matcha", price: "99.000đ", image: "assets/image/product/banh-trung-thu-matcha.png" },
                { id: 4, name: "Bánh Trung Thu Murasaki Imo", price: "115.000đ", image: "assets/image/product/banh-trung-thu-murasaki-Imo.png" },
                { id: 5, name: "Bánh Trung Thu Mushroom Mixed Nuts", price: "129.000đ", image: "assets/image/product/banh-trung-thu-mushroom-mixed-nuts.png" },
                { id: 6, name: "Bánh Trung Thu Pink Nocturne", price: "105.000đ", image: "assets/image/product/banh-trung-thu-pink-nocturne.png" },
                { id: 7, name: "Bánh Trung Thu Takesumi Orange", price: "125.000đ", image: "assets/image/product/banh-trung-thu-takesumi-orange.png" },
                { id: 8, name: "Bánh Trung Thu Xôi Gấc", price: "95.000đ", image: "assets/image/product/banh-trung-thu-xoi-gac.png" }
            ];

            function searchProducts() {
                const keyword = searchInput.value.trim().toLowerCase();
                resultsBox.innerHTML = "";
                if(keyword === "") {
                    resultsBox.classList.remove("active");
                    return;
                }

                const filtered = products.filter(p => p.name.toLowerCase().includes(keyword));
                if(filtered.length === 0) {
                    resultsBox.innerHTML = `<p style="text-align:center; padding:10px; color:#8B0000;">Không tìm thấy sản phẩm</p>`;
                    resultsBox.classList.add("active");
                    return;
                }

                filtered.forEach(p => {
                    const item = document.createElement("div");
                    item.classList.add("product-item");
                    item.innerHTML = `
                        <img src="${p.image}" alt="${p.name}">
                        <div>
                            <h4>${p.name}</h4>
                            <p>Giá: ${p.price}</p>
                        </div>
                    `;
                    item.addEventListener("click", () => {
                        window.location.href = `product-detail.html?id=${p.id}`;
                    });
                    resultsBox.appendChild(item);
                });
                resultsBox.classList.add("active");
            }

            searchButton.addEventListener("click", searchProducts);
            searchInput.addEventListener("keypress", e => {
                if(e.key === "Enter") searchProducts();
            });

            document.addEventListener("click", e => {
                if(!e.target.closest(".search-bar") && !e.target.closest(".search-results")) {
                    resultsBox.classList.remove("active");
                }
            });

            // Kiểm tra nếu không có dữ liệu, tạo dữ liệu mẫu
            const purchaseHistory = JSON.parse(localStorage.getItem("purchaseHistory")) || [];
            const orders = JSON.parse(localStorage.getItem("orders")) || [];
            
            if (purchaseHistory.length === 0 && orders.length === 0) {
                createSampleData();
            }
            
            loadPurchaseHistory();
        });

        // 4. XỬ LÝ BẬT/TẮT DROPDOWN
        userIcon.addEventListener("click", e => {
            e.stopPropagation(); 
            dropdown.classList.toggle("active");
        });

        document.addEventListener("click", e => {
            if(!dropdown.contains(e.target) && !userIcon.contains(e.target)) {
                dropdown.classList.remove("active");
            }
        });

        /**
         * Lắng nghe sự thay đổi của giỏ hàng từ các trang khác (ví dụ: product.html)
         * Nếu giỏ hàng thay đổi ở tab khác, tab này cũng sẽ tự động cập nhật số lượng
         */
        window.addEventListener('storage', (e) => {
            if (e.key === 'cart') {
                updateCartCount();
            }
            if (e.key === 'currentUser') {
                updateUserMenu();
                updateCartCount();
            }
        });
    </script>
</body>
</html>